#!/usr/bin/env bash
set -euo pipefail

run_serena() {
  local candidate="$1"
  shift
  [[ -n "${candidate}" && -x "${candidate}" ]] || return 1
  exec "${candidate}" "$@"
}

# 1) Prefer an explicit Serena on PATH (fastest / most stable).
if command -v serena >/dev/null 2>&1; then
  run_serena "$(command -v serena)" "$@"
fi

# 2) Fall back to the most recent uvx cached Serena executable.
if [[ -d "${HOME}/.cache/uv/archive-v0" ]]; then
  latest_cached_serena="$(ls -t "${HOME}"/.cache/uv/archive-v0/*/bin/serena 2>/dev/null | head -n 1 || true)"
  if [[ -n "${latest_cached_serena}" ]]; then
    run_serena "${latest_cached_serena}" "$@"
  fi
fi

# 3) Last resort: run via uvx (may require network and can be sandbox-unfriendly).
exec uvx --from git+https://github.com/oraios/serena serena "$@"
