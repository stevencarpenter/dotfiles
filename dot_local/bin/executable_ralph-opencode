#!/usr/bin/env bash

# ralph-opencode - Autonomous coding agent with local model and MCP support
# Version: 2.0.0
# Features: Project-level config, PRD management, init scaffolding, metrics tracking

set -euo pipefail

# Script metadata
readonly SCRIPT_NAME="$(basename "$0")"
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly SCRIPT_VERSION="2.0.0"

# Default paths
readonly GLOBAL_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
readonly GLOBAL_RALPH_CONFIG="${GLOBAL_CONFIG_DIR}/ralph/ralph.json"
readonly GLOBAL_OPENCODE_CONFIG="${GLOBAL_CONFIG_DIR}/opencode/opencode.json"
readonly GLOBAL_RULES_FILE="${GLOBAL_CONFIG_DIR}/opencode/rules.toml"
readonly STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/ralph"
readonly SECRETS_DIR="${XDG_RUNTIME_DIR:-/tmp}/ralph-secrets"

# Color codes
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Global variables
REPO_ROOT=""
PROJECT_CONFIG_DIR=""
PROJECT_RALPH_CONFIG=""
PROJECT_OPENCODE_CONFIG=""
PROJECT_RULES_FILE=""
PROJECT_INSTRUCTIONS=""
PROJECT_PRD_DIR=""
VERBOSE=false
DRY_RUN=false
SAFE_MODE=false
MAX_HOURS=""
UNTIL_COMPLETE=false
PRD_FILE=""
MODEL=""
PROVIDER=""

# ============================================================================
# LOGGING FUNCTIONS
# ============================================================================

log_info() {
    echo -e "${BLUE}[INFO]${NC} $*" >&2
}

log_success() {
    echo -e "${GREEN}[âœ“]${NC} $*" >&2
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*" >&2
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
}

log_debug() {
    if [[ "$VERBOSE" == true ]]; then
        echo -e "${BLUE}[DEBUG]${NC} $*" >&2
    fi
}

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

find_git_root() {
    local dir="${1:-.}"
    dir="$(cd "$dir" 2>/dev/null && pwd -P)" || return 1

    # Loop up the directory tree with safety limit
    local count=0
    local max_depth=100
    while [[ $count -lt $max_depth ]] && [[ "$dir" != "/" ]] && [[ -n "$dir" ]]; do
        if [[ -d "$dir/.git" ]]; then
            echo "$dir"
            return 0
        fi
        # Move up one directory
        if [[ "$dir" == "/" ]]; then
            break
        fi
        dir="${dir%/*}"
        ((count++))
    done
    return 1
}

repo_hash() {
    local repo_root="${1:-.}"
    if [[ -f "$repo_root/.git/HEAD" ]]; then
        git -C "$repo_root" rev-parse HEAD 2>/dev/null | cut -c1-8
    else
        echo "unknown"
    fi
}

ensure_directories() {
    mkdir -p "$STATE_DIR" "$SECRETS_DIR"
    chmod 700 "$SECRETS_DIR"
}

# ============================================================================
# PROJECT CONFIGURATION DETECTION
# ============================================================================

detect_project_config() {
    PROJECT_CONFIG_DIR="${REPO_ROOT}/.opencode"
    PROJECT_RALPH_CONFIG="${REPO_ROOT}/ralph.json"
    PROJECT_OPENCODE_CONFIG="${REPO_ROOT}/opencode.json"
    PROJECT_RULES_FILE="${REPO_ROOT}/rules.toml"

    # Detect instruction files
    if [[ -f "${REPO_ROOT}/.instructions.md" ]]; then
        PROJECT_INSTRUCTIONS="${REPO_ROOT}/.instructions.md"
    elif [[ -f "${REPO_ROOT}/AGENTS.md" ]]; then
        PROJECT_INSTRUCTIONS="${REPO_ROOT}/AGENTS.md"
    elif [[ -f "${REPO_ROOT}/CLAUDE.md" ]]; then
        PROJECT_INSTRUCTIONS="${REPO_ROOT}/CLAUDE.md"
    fi

    # Detect PRD directory
    if [[ -d "${REPO_ROOT}/prds" ]]; then
        PROJECT_PRD_DIR="${REPO_ROOT}/prds"
    elif [[ -d "${REPO_ROOT}/.prds" ]]; then
        PROJECT_PRD_DIR="${REPO_ROOT}/.prds"
    fi

    log_debug "Project config detected:"
    log_debug "  Ralph config: ${PROJECT_RALPH_CONFIG}"
    log_debug "  OpenCode config: ${PROJECT_OPENCODE_CONFIG}"
    log_debug "  Rules file: ${PROJECT_RULES_FILE}"
    log_debug "  Instructions: ${PROJECT_INSTRUCTIONS}"
    log_debug "  PRD directory: ${PROJECT_PRD_DIR}"
}

# ============================================================================
# CONFIGURATION LOADING
# ============================================================================

load_config() {
    local config_file="${1:-}"

    if [[ -z "$config_file" ]] || [[ ! -f "$config_file" ]]; then
        return 0
    fi

    if ! command -v jq &>/dev/null; then
        log_error "jq is required but not installed"
        return 1
    fi

    log_debug "Loading config: $config_file"

    if ! jq . "$config_file" >/dev/null 2>&1; then
        log_error "Invalid JSON in $config_file"
        return 1
    fi

    return 0
}

load_secrets() {
    if [[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/zsh/.env" ]]; then
        # shellcheck disable=SC1090
        source "${XDG_CONFIG_HOME:-$HOME/.config}/zsh/.env" 2>/dev/null || true
    fi
}

# ============================================================================
# PROJECT CONFIGURATION LOADING
# ============================================================================

load_project_config() {
    log_debug "Loading project configuration from $REPO_ROOT"

    detect_project_config

    # Validate project configs
    if [[ -f "$PROJECT_RALPH_CONFIG" ]]; then
        load_config "$PROJECT_RALPH_CONFIG" || log_warn "Invalid project ralph.json"
    fi

    if [[ -f "$PROJECT_OPENCODE_CONFIG" ]]; then
        load_config "$PROJECT_OPENCODE_CONFIG" || log_warn "Invalid project opencode.json"
    fi

    if [[ -f "$PROJECT_RULES_FILE" ]]; then
        if ! command -v toml-cli &>/dev/null && ! command -v yq &>/dev/null; then
            log_debug "TOML parser not available, skipping validation"
        fi
    fi

    if [[ -f "$PROJECT_INSTRUCTIONS" ]]; then
        log_debug "Found project instructions: $PROJECT_INSTRUCTIONS"
    fi

    if [[ -n "$PROJECT_PRD_DIR" && -d "$PROJECT_PRD_DIR" ]]; then
        log_debug "Found PRD directory: $PROJECT_PRD_DIR"
    fi
}

# ============================================================================
# PRD MANAGEMENT
# ============================================================================

cmd_prd_list() {
    if [[ -z "$PROJECT_PRD_DIR" ]] || [[ ! -d "$PROJECT_PRD_DIR" ]]; then
        log_error "No PRD directory found in project"
        return 1
    fi

    local prds=()
    while IFS= read -r -d '' prd; do
        prds+=("$prd")
    done < <(find "$PROJECT_PRD_DIR" -maxdepth 1 -type f \( -name "*.json" -o -name "*.yml" -o -name "*.yaml" \) -print0 2>/dev/null)

    if [[ ${#prds[@]} -eq 0 ]]; then
        log_info "No PRD files found in $PROJECT_PRD_DIR"
        return 0
    fi

    echo "Available PRD files:"
    for i in "${!prds[@]}"; do
        local basename=$(basename "${prds[$i]}")
        echo "  $((i + 1)). $basename"
    done
}

cmd_prd_select() {
    if [[ -z "$PROJECT_PRD_DIR" ]] || [[ ! -d "$PROJECT_PRD_DIR" ]]; then
        log_error "No PRD directory found in project"
        return 1
    fi

    local prds=()
    while IFS= read -r -d '' prd; do
        prds+=("$prd")
    done < <(find "$PROJECT_PRD_DIR" -maxdepth 1 -type f \( -name "*.json" -o -name "*.yml" -o -name "*.yaml" \) -print0 2>/dev/null)

    if [[ ${#prds[@]} -eq 0 ]]; then
        log_error "No PRD files found in $PROJECT_PRD_DIR"
        return 1
    fi

    if [[ ${#prds[@]} -eq 1 ]]; then
        PRD_FILE="${prds[0]}"
        log_info "Using PRD: $(basename "$PRD_FILE")"
    else
        echo "Select a PRD file:"
        for i in "${!prds[@]}"; do
            local basename=$(basename "${prds[$i]}")
            echo "  $((i + 1)). $basename"
        done

        read -p "Enter selection (1-${#prds[@]}): " selection

        if ! [[ "$selection" =~ ^[0-9]+$ ]] || ((selection < 1 || selection > ${#prds[@]})); then
            log_error "Invalid selection"
            return 1
        fi

        PRD_FILE="${prds[$((selection - 1))]}"
        log_info "Using PRD: $(basename "$PRD_FILE")"
    fi

    cmd_run
}

# ============================================================================
# CONFIGURATION COMMANDS
# ============================================================================

cmd_config_show() {
    log_info "Global Configuration"
    if [[ -f "$GLOBAL_RALPH_CONFIG" ]]; then
        echo "Ralph Config: $GLOBAL_RALPH_CONFIG"
        head -3 "$GLOBAL_RALPH_CONFIG" | sed 's/^/  /'
    fi

    if [[ -f "$GLOBAL_OPENCODE_CONFIG" ]]; then
        echo "OpenCode Config: $GLOBAL_OPENCODE_CONFIG"
        head -3 "$GLOBAL_OPENCODE_CONFIG" | sed 's/^/  /'
    fi

    if [[ -n "$REPO_ROOT" ]]; then
        log_info "Project Configuration (in $REPO_ROOT)"
        if [[ -f "$PROJECT_RALPH_CONFIG" ]]; then
            echo "Ralph Config: $PROJECT_RALPH_CONFIG (overrides global)"
        fi
        if [[ -f "$PROJECT_OPENCODE_CONFIG" ]]; then
            echo "OpenCode Config: $PROJECT_OPENCODE_CONFIG (overrides global)"
        fi
        if [[ -f "$PROJECT_RULES_FILE" ]]; then
            echo "Rules File: $PROJECT_RULES_FILE"
        fi
        if [[ -f "$PROJECT_INSTRUCTIONS" ]]; then
            echo "Instructions: $PROJECT_INSTRUCTIONS"
        fi
        if [[ -d "$PROJECT_PRD_DIR" ]]; then
            echo "PRD Directory: $PROJECT_PRD_DIR"
        fi
    fi
}

cmd_config_check() {
    log_info "Checking configuration..."
    local errors=0

    # Check global configs
    if [[ ! -f "$GLOBAL_RALPH_CONFIG" ]]; then
        log_warn "Global ralph.json not found: $GLOBAL_RALPH_CONFIG"
        ((errors++))
    elif ! load_config "$GLOBAL_RALPH_CONFIG"; then
        ((errors++))
    fi

    if [[ ! -f "$GLOBAL_OPENCODE_CONFIG" ]]; then
        log_warn "Global opencode.json not found: $GLOBAL_OPENCODE_CONFIG"
        ((errors++))
    elif ! load_config "$GLOBAL_OPENCODE_CONFIG"; then
        ((errors++))
    fi

    # Check project configs
    if [[ -n "$REPO_ROOT" ]]; then
        if [[ -f "$PROJECT_RALPH_CONFIG" ]]; then
            load_config "$PROJECT_RALPH_CONFIG" || ((errors++))
        fi

        if [[ -f "$PROJECT_OPENCODE_CONFIG" ]]; then
            load_config "$PROJECT_OPENCODE_CONFIG" || ((errors++))
        fi
    fi

    # Check dependencies
    local deps=("opencode" "jq")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &>/dev/null; then
            log_warn "Dependency not found: $dep"
            ((errors++))
        fi
    done

    if [[ $errors -eq 0 ]]; then
        log_success "All checks passed"
        return 0
    else
        log_error "Found $errors issue(s)"
        return 1
    fi
}

# ============================================================================
# DOCTOR COMMAND
# ============================================================================

cmd_doctor() {
    log_info "System Health Check"

    local status=0

    echo ""
    echo "Checking dependencies:"
    local required_cmds=("bash" "git" "jq" "opencode")
    for cmd in "${required_cmds[@]}"; do
        if command -v "$cmd" &>/dev/null; then
            local version=$($cmd --version 2>&1 | head -1)
            log_success "$cmd: installed ($version)"
        else
            log_error "$cmd: NOT INSTALLED"
            ((status++))
        fi
    done

    echo ""
    echo "Checking paths:"
    [[ -d "$STATE_DIR" ]] && log_success "State directory: $STATE_DIR" || log_warn "State directory not found: $STATE_DIR"
    [[ -d "$GLOBAL_CONFIG_DIR" ]] && log_success "Config directory: $GLOBAL_CONFIG_DIR" || log_warn "Config directory not found: $GLOBAL_CONFIG_DIR"

    echo ""
    echo "Checking configurations:"
    [[ -f "$GLOBAL_RALPH_CONFIG" ]] && log_success "Ralph config: $GLOBAL_RALPH_CONFIG" || log_warn "Ralph config not found"
    [[ -f "$GLOBAL_OPENCODE_CONFIG" ]] && log_success "OpenCode config: $GLOBAL_OPENCODE_CONFIG" || log_warn "OpenCode config not found"

    if [[ -n "$REPO_ROOT" ]]; then
        echo ""
        echo "Checking project configuration in $REPO_ROOT:"
        [[ -f "$PROJECT_RALPH_CONFIG" ]] && log_success "Project ralph.json found" || log_debug "No project ralph.json"
        [[ -f "$PROJECT_OPENCODE_CONFIG" ]] && log_success "Project opencode.json found" || log_debug "No project opencode.json"
        [[ -f "$PROJECT_RULES_FILE" ]] && log_success "Project rules.toml found" || log_debug "No project rules.toml"
        [[ -f "$PROJECT_INSTRUCTIONS" ]] && log_success "Project instructions found: $PROJECT_INSTRUCTIONS" || log_debug "No project instructions"
        [[ -d "$PROJECT_PRD_DIR" ]] && log_success "PRD directory found: $PROJECT_PRD_DIR" || log_debug "No PRD directory"
    fi

    return $status
}

# ============================================================================
# INIT COMMAND
# ============================================================================

cmd_init() {
    if [[ -z "$REPO_ROOT" ]]; then
        log_error "Not in a git repository"
        return 1
    fi

    log_info "Initializing project structure in $REPO_ROOT"

    # Create project config directory
    mkdir -p "$REPO_ROOT/.opencode/agents"
    log_success "Created .opencode/agents directory"

    # Create PRD directory
    mkdir -p "$REPO_ROOT/prds"
    log_success "Created prds directory"

    # Create ralph.json template
    if [[ ! -f "$PROJECT_RALPH_CONFIG" ]]; then
        cat > "$PROJECT_RALPH_CONFIG" << 'EOF'
{
  "loop": {
    "maxIterations": 10,
    "timeout": 3600
  },
  "safeMode": {
    "enabled": false,
    "rulesFile": "rules.toml"
  },
  "secrets": {
    "enabled": true,
    "vault": ".opencode/secrets"
  }
}
EOF
        log_success "Created ralph.json"
    else
        log_debug "ralph.json already exists"
    fi

    # Create opencode.json template
    if [[ ! -f "$PROJECT_OPENCODE_CONFIG" ]]; then
        cat > "$PROJECT_OPENCODE_CONFIG" << 'EOF'
{
  "model": "local",
  "provider": "lm-studio",
  "tools": {
    "shell": { "enabled": true },
    "filesystem": { "enabled": true, "root": "." },
    "memory": { "enabled": true }
  },
  "agents": {
    "default": {
      "instructions": ".instructions.md",
      "maxRetries": 3
    }
  }
}
EOF
        log_success "Created opencode.json"
    else
        log_debug "opencode.json already exists"
    fi

    # Create .instructions.md template
    if [[ ! -f "${REPO_ROOT}/.instructions.md" ]]; then
        cat > "${REPO_ROOT}/.instructions.md" << 'EOF'
# Project Instructions for Ralph/OpenCode

## Overview
This file contains instructions for autonomous coding agents working on this project.

## Project Context
- **Repository**: Add repository description
- **Tech Stack**: Add tech stack details
- **Key Files**: List important files and directories

## Agent Instructions

### Do's
- Follow the existing code style and patterns
- Add tests for new functionality
- Update documentation when changing APIs
- Commit with clear, descriptive messages

### Don'ts
- Don't modify deployment configurations
- Don't delete or rename existing files without approval
- Don't add large dependencies without discussion
- Don't commit to main branch without review

## Important Considerations
- List project-specific considerations
- Document any constraints or limitations
- Explain critical business logic

## Testing Requirements
- Unit tests required for features
- Integration tests for API changes
- Manual testing for UI changes

## Success Criteria
- All tests pass
- No breaking changes
- Code follows project standards
EOF
        log_success "Created .instructions.md"
    else
        log_debug ".instructions.md already exists"
    fi

    # Create rules.toml template for safe mode
    if [[ ! -f "$PROJECT_RULES_FILE" ]]; then
        cat > "$PROJECT_RULES_FILE" << 'EOF'
# Safe Mode Rules for Ralph/OpenCode
# Define what operations are allowed when safe mode is enabled

[filesystem]
allow_read = ["."]
allow_write = ["src/", "tests/", "docs/"]
deny_write = [".git/", "node_modules/", "dist/", ".env"]

[shell]
allow_commands = ["git", "npm", "python", "make", "docker"]
deny_commands = ["rm -rf", "sudo", "chown"]

[network]
allow_hosts = ["api.github.com", "github.com"]
deny_hosts = ["*.internal"]
EOF
        log_success "Created rules.toml"
    else
        log_debug "rules.toml already exists"
    fi

    # Create sample PRD
    if [[ ! -f "${REPO_ROOT}/prds/sample.json" ]]; then
        cat > "${REPO_ROOT}/prds/sample.json" << 'EOF'
{
  "title": "Sample PRD",
  "description": "Example Product Requirements Document",
  "objective": "Define what the agent should do",
  "requirements": [
    "Add tests for new functionality",
    "Update documentation",
    "Follow code style guidelines"
  ],
  "success_criteria": [
    "All tests pass",
    "Code review approved",
    "No breaking changes"
  ],
  "constraints": [
    "Don't modify deployment configs",
    "Maintain backward compatibility"
  ]
}
EOF
        log_success "Created sample PRD: prds/sample.json"
    fi

    log_success "Project initialization complete!"
}

# ============================================================================
# METRICS TRACKING
# ============================================================================

record_metrics() {
    local repo_root="${1:-}"
    local command="${2:-run}"
    local status="${3:-started}"
    local duration="${4:-0}"

    if [[ -z "$repo_root" ]]; then
        return 0
    fi

    ensure_directories

    local hash=$(repo_hash "$repo_root")
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local metrics_file="${STATE_DIR}/${hash}-metrics.json"

    if [[ ! -f "$metrics_file" ]]; then
        echo "[]" > "$metrics_file"
    fi

    if command -v jq &>/dev/null; then
        jq --arg ts "$timestamp" --arg cmd "$command" --arg st "$status" --arg dur "$duration" \
            '. += [{timestamp: $ts, command: $cmd, status: $st, duration: ($dur | tonumber)}]' \
            "$metrics_file" > "${metrics_file}.tmp" && mv "${metrics_file}.tmp" "$metrics_file"
    fi
}

# ============================================================================
# RUN ITERATION
# ============================================================================

run_iteration() {
    local iteration="${1:-1}"
    local max_iterations="${2:-10}"

    log_info "Running iteration $iteration/$max_iterations"

    if [[ "$DRY_RUN" == true ]]; then
        log_info "[DRY RUN] Would execute: opencode run"
        return 0
    fi

    # Build opencode command
    local cmd=("opencode" "run")

    if [[ -n "$PRD_FILE" ]]; then
        cmd+=("--prd" "$PRD_FILE")
    fi

    if [[ "$VERBOSE" == true ]]; then
        cmd+=("-v")
    fi

    if [[ "$SAFE_MODE" == true ]]; then
        cmd+=("--safe")
        if [[ -f "$PROJECT_RULES_FILE" ]]; then
            cmd+=("--rules" "$PROJECT_RULES_FILE")
        fi
    fi

    if [[ -f "$PROJECT_OPENCODE_CONFIG" ]]; then
        cmd+=("--config" "$PROJECT_OPENCODE_CONFIG")
    fi

    log_debug "Executing: ${cmd[*]}"

    if "${cmd[@]}"; then
        log_success "Iteration $iteration completed successfully"
        return 0
    else
        log_warn "Iteration $iteration encountered issues"
        return 1
    fi
}

# ============================================================================
# MAIN RUN COMMAND
# ============================================================================

cmd_run() {
    local start_time=$(date +%s)

    log_info "Starting ralph-opencode run"
    log_debug "Repository: $REPO_ROOT"
    log_debug "Config: $PROJECT_OPENCODE_CONFIG"

    record_metrics "$REPO_ROOT" "run" "started"

    local max_iterations=10
    if [[ -f "$PROJECT_RALPH_CONFIG" ]] && command -v jq &>/dev/null; then
        max_iterations=$(jq -r '.loop.maxIterations // 10' "$PROJECT_RALPH_CONFIG")
    fi

    local iteration=1
    local max_time=""
    if [[ -n "$MAX_HOURS" ]]; then
        max_time=$((MAX_HOURS * 3600))
    fi

    while ((iteration <= max_iterations)); do
        if [[ -n "$max_time" ]]; then
            local elapsed=$(($(date +%s) - start_time))
            if ((elapsed >= max_time)); then
                log_info "Max time reached ($MAX_HOURS hours)"
                break
            fi
        fi

        if ! run_iteration "$iteration" "$max_iterations"; then
            if [[ "$UNTIL_COMPLETE" != true ]]; then
                break
            fi
        fi

        if [[ "$UNTIL_COMPLETE" != true ]]; then
            break
        fi

        ((iteration++))
    done

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))

    record_metrics "$REPO_ROOT" "run" "completed" "$duration"
    log_success "Run completed in $duration seconds"
}

# ============================================================================
# METRICS COMMAND
# ============================================================================

cmd_metrics() {
    if [[ -z "$REPO_ROOT" ]]; then
        log_error "Not in a git repository"
        return 1
    fi

    local hash=$(repo_hash "$REPO_ROOT")
    local metrics_file="${STATE_DIR}/${hash}-metrics.json"

    if [[ ! -f "$metrics_file" ]]; then
        log_info "No metrics found for this repository"
        return 0
    fi

    log_info "Metrics for $REPO_ROOT"

    if command -v jq &>/dev/null; then
        jq '.' "$metrics_file" | head -50
    else
        head -50 "$metrics_file"
    fi
}

# ============================================================================
# OPENCODE CONFIG GENERATION
# ============================================================================

generate_opencode_config() {
    local output_file="${1:--}"
    local config_template="${2:-}"

    if [[ -z "$config_template" ]]; then
        config_template="$PROJECT_OPENCODE_CONFIG"
        if [[ ! -f "$config_template" ]]; then
            config_template="$GLOBAL_OPENCODE_CONFIG"
        fi
    fi

    if [[ ! -f "$config_template" ]]; then
        log_error "OpenCode config template not found"
        return 1
    fi

    if [[ "$output_file" == "-" ]]; then
        cat "$config_template"
    else
        cat "$config_template" > "$output_file"
        log_success "Generated config: $output_file"
    fi
}

# ============================================================================
# ARGUMENT PARSING
# ============================================================================

parse_args() {
    local cmd="run"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            --version)
                echo "$SCRIPT_NAME v$SCRIPT_VERSION"
                exit 0
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            --safe)
                SAFE_MODE=true
                shift
                ;;
            --max-hours)
                MAX_HOURS="${2:-}"
                if [[ -z "$MAX_HOURS" ]]; then
                    log_error "--max-hours requires an argument"
                    return 1
                fi
                shift 2
                ;;
            --until-complete)
                UNTIL_COMPLETE=true
                shift
                ;;
            --prd)
                PRD_FILE="${2:-}"
                if [[ -z "$PRD_FILE" ]]; then
                    log_error "--prd requires an argument"
                    return 1
                fi
                shift 2
                ;;
            --model)
                MODEL="${2:-}"
                if [[ -z "$MODEL" ]]; then
                    log_error "--model requires an argument"
                    return 1
                fi
                shift 2
                ;;
            --provider)
                PROVIDER="${2:-}"
                if [[ -z "$PROVIDER" ]]; then
                    log_error "--provider requires an argument"
                    return 1
                fi
                shift 2
                ;;
            config)
                cmd="config"
                shift
                ;;
            doctor)
                cmd="doctor"
                shift
                ;;
            init)
                cmd="init"
                shift
                ;;
            metrics)
                cmd="metrics"
                shift
                ;;
            prd)
                cmd="prd"
                shift
                if [[ $# -gt 0 ]]; then
                    case "$1" in
                        list|select|run)
                            cmd="prd-$1"
                            shift
                            ;;
                    esac
                fi
                ;;
            show)
                cmd="config-show"
                shift
                ;;
            check)
                cmd="config-check"
                shift
                ;;
            *)
                log_error "Unknown option or command: $1"
                return 1
                ;;
        esac
    done

    echo "$cmd"
}

# ============================================================================
# USAGE
# ============================================================================

usage() {
    cat << 'EOF'
ralph-opencode - Autonomous coding agent with local model and MCP support

USAGE:
    ralph-opencode [OPTIONS] [COMMAND] [ARGS]

GLOBAL OPTIONS:
    -h, --help              Show this help message
    -v, --verbose           Enable verbose output
    --version               Show version
    --dry-run               Preview actions without executing
    --safe                  Enable safe mode (requires rules.toml)
    --max-hours HOURS       Maximum runtime in hours
    --until-complete        Keep iterating until complete
    --prd FILE              PRD file to use
    --model MODEL           Override model selection
    --provider PROVIDER     Override provider selection

COMMANDS:
    run [OPTIONS]           Execute ralph-opencode (default)
    init                    Initialize project structure
    doctor                  System health check
    config show             Display configuration
    config check            Validate configuration
    metrics                 Show recorded metrics
    prd list                List available PRDs
    prd select              Interactively select and run PRD
    prd run                 Alias for prd select

EXAMPLES:
    # Run with default PRD
    ralph-opencode run

    # Run with specific PRD
    ralph-opencode --prd prds/feature.json run

    # Run until complete with safe mode
    ralph-opencode --safe --until-complete run

    # Interactive PRD selection
    ralph-opencode prd select

    # Initialize project
    ralph-opencode init

    # Check system health
    ralph-opencode doctor

    # Show configuration
    ralph-opencode config show

VERSION: 2.0.0
EOF
}

# ============================================================================
# MAIN
# ============================================================================

main() {
    # Initialize
    ensure_directories
    load_secrets

    # Determine repository root
    if ! REPO_ROOT=$(find_git_root); then
        log_warn "Not in a git repository"
        REPO_ROOT=""
    else
        load_project_config
    fi

    # Parse command-line arguments
    local cmd
    if ! cmd=$(parse_args "$@"); then
        return 1
    fi

    # Execute command
    case "$cmd" in
        run)
            cmd_run
            ;;
        init)
            cmd_init
            ;;
        doctor)
            cmd_doctor
            ;;
        config)
            cmd_config_show
            ;;
        config-show)
            cmd_config_show
            ;;
        config-check)
            cmd_config_check
            ;;
        metrics)
            cmd_metrics
            ;;
        prd-list)
            cmd_prd_list
            ;;
        prd-select|prd-run)
            cmd_prd_select
            ;;
        *)
            log_error "Unknown command: $cmd"
            usage
            return 1
            ;;
    esac
}

# Run main if sourced properly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
