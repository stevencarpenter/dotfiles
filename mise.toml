[env]
GIT_SSH_COMMAND="ssh -i ~/.ssh/id_ed25519_personal -o IdentitiesOnly=yes"

[tools]
# Repo-relevant tooling (pin to known-good versions for reproducibility)
chezmoi = "2.69.3"
age = "1.3.1"
jq = "1.8.1"
pre-commit = "3.7.1"
python = "3.12.12"

[tasks.diff]
description = "Preview changes that would be applied"
run = "chezmoi diff"

[tasks.apply]
description = "Apply dotfiles"
run = "chezmoi apply"

[tasks.apply-verbose]
description = "Apply dotfiles (verbose)"
run = "chezmoi apply -v"

[tasks.status]
description = "Show chezmoi status"
run = "chezmoi status --no-pager"

[tasks.managed]
description = "List managed targets"
run = "chezmoi managed"

[tasks.update]
description = "Update from remote and apply"
run = "chezmoi update"

[tasks.sync-mcp]
description = "Manually sync MCP configs (normally runs after apply)"
run = "bash scripts/sync-mcp-configs.sh"

[tasks.pre-commit]
description = "Run all pre-commit hooks"
run = "pre-commit run --all-files"

[tasks.reconcile]
description = "Re-add locally modified managed files back into chezmoi source"
run = """
set -eu
set -o pipefail 2>/dev/null || true

modified="$(chezmoi status --no-pager --path-style relative | awk 'substr($0,1,1) == \"M\" {print substr($0,4)}')"

if [ -z "$modified" ]; then
  echo "No modified managed files to re-add."
  exit 0
fi

printf '%s\n' "$modified" | while IFS= read -r target; do
  echo "chezmoi re-add ${target}"
  chezmoi re-add -- "${target}"
done
"""
