# Personal Zsh configuration file. It is strongly recommended to keep all
# shell customization and configuration (including exported environment
# variables such as PATH) in this file or in files sourced from it.
#
# Documentation: https://github.com/romkatv/zsh4humans/blob/v5/README.md.

## Zshell profiling flags (uncomment to profile startup time)
# zmodload zsh/zprof

# ============================================================================
# PRE-INIT SETUP (before z4h init)
# ============================================================================

# Autoload functions (required by AWS SSO CLI, must be before z4h init)
autoload -Uz +X compinit && compinit
autoload -Uz +X bashcompinit && bashcompinit
autoload -Uz zmv

# === z4h configuration (zstyles) ===
# Periodic auto-update on Zsh startup: 'ask' or 'no'.
zstyle ':z4h:' auto-update      'yes'
zstyle ':z4h:' auto-update-days '28'

# Keyboard type: 'mac' or 'pc'.
zstyle ':z4h:bindkey' keyboard  'mac'

# Start tmux if not already in tmux.
# zstyle ':z4h:' start-tmux command tmux -u new -A -D -t z4h

# Whether to move prompt to the bottom when zsh starts and on Ctrl+L.
zstyle ':z4h:' prompt-at-bottom 'yes'

# Mark up shell's output with semantic information.
zstyle ':z4h:' term-shell-integration 'yes'

# Right-arrow key accepts one character ('partial-accept') from
# command autosuggestions or the whole thing ('accept')?
zstyle ':z4h:autosuggestions' forward-char 'accept'

# Recursively traverse directories when TAB-completing files.
zstyle ':z4h:fzf-complete' recurse-dirs 'yes'

# Enable direnv to automatically source .envrc files.
zstyle ':z4h:direnv'         enable 'yes'
zstyle ':z4h:direnv:success' notify 'yes'

# Enable ('yes') or disable ('no') automatic teleportation of z4h over SSH.
zstyle ':z4h:ssh:example-hostname1'   enable 'yes'
zstyle ':z4h:ssh:*.example-hostname2' enable 'no'
zstyle ':z4h:ssh:*'                   enable 'no'

# Send these files over to the remote host when connecting over SSH.
# zstyle ':z4h:ssh:*' send-extra-files '~/$XDG_CONFIG_HOME/.nanorc' '~/.env.zsh'

# Clone additional Git repositories from GitHub (example).
# z4h install ohmyzsh/ohmyzsh || return

# Install or update core components (fzf, zsh-autosuggestions, etc.) and
# initialize Zsh. After this point console I/O is unavailable until Zsh
# is fully initialized. Everything that requires user interaction or can
# perform network I/O must be done above. Everything else is best done below.
z4h init || return

# ============================================================================
# POST-INIT CUSTOMIZATION (after z4h init)
# ============================================================================

# === 1. Homebrew Setup (must be early, other tools depend on it) ===
if [[ $(uname) == "Darwin" ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# === 2. PATH Configuration (consolidated for clarity) ===
path=(
    $HOME/.opencode/bin
    $HOME/.local/bin
    ~/bin
    /opt/homebrew/opt/libpq/bin
    "/Applications/IntelliJ IDEA.app/Contents/MacOS"
    $HOME/.lmstudio/bin
    $HOME/.amp/bin
    $path
)

# bun
export BUN_INSTALL="$HOME/.bun"
path=($BUN_INSTALL/bin $path)

export PATH

# === 3. Environment Variables ===
export GPG_TTY=$TTY
export NPM_CONFIG_PYTHON="$(command -v python3)"

# === 4. Source Encrypted/Local Files ===
# Note: `~/.config/zsh/.env` is generated from an encrypted source; ensure vars are exported for child processes.
z4h source ~/.env.zsh
if [[ -r "$XDG_CONFIG_HOME/zsh/.env" ]]; then
  set -a
  source -- "$XDG_CONFIG_HOME/zsh/.env"
  set +a
fi

# GitHub token from gh CLI (for MCP servers and other tooling).
#
# Note: `gh auth status` can succeed later in the session even if it fails during
# early shell startup (keychain/agent timing). To make this robust, we:
# - attempt once during startup
# - retry automatically before each prompt until it succeeds (then unregister)
__zsh_set_github_token() {
  [[ -n "${GITHUB_TOKEN-}" ]] && return 0
  command -v gh >/dev/null 2>&1 || return 0

  local token
  token="$(gh auth token 2>/dev/null)" || return 0
  [[ -n "$token" ]] || return 0

  typeset -gx GITHUB_TOKEN="$token"
  typeset -gx GITHUB_PERSONAL_ACCESS_TOKEN="${GITHUB_PERSONAL_ACCESS_TOKEN:-$token}"
}

__zsh_set_github_token_precmd() {
  __zsh_set_github_token
  [[ -n "${GITHUB_TOKEN-}" ]] && add-zsh-hook -d precmd __zsh_set_github_token_precmd 2>/dev/null || true
}

autoload -Uz add-zsh-hook
__zsh_set_github_token
add-zsh-hook -Uz precmd __zsh_set_github_token_precmd

# === 5. Aliases ===
# Git aliases
alias gfp='git fetch --all && git pull'
alias gss='git status -sb'

# Docker aliases
alias docker-clean-unused='docker system prune --all --force --volumes'
alias docker-clean-all='docker stop $(docker container ls -a -q); docker system prune -a -f --volumes'

# Editor aliases
alias vi='nvim'
alias vim='nvim'
alias nano='nvim'
alias emacs='nvim'

# Utility aliases
alias tree='tree -a -I .git'
alias l='ls -lah'
alias la='ls -lAh'
alias ll='ls -lh'
alias ls='ls -G'
alias lsa='ls -lah'
alias sed='gsed'
alias teeclip='tee >(pbcopy)'

# Tool shortcuts
alias k='kubectl'
alias s='stevectl'
alias lzg='lazygit'
alias tig='git log --reverse'
alias lzd='lazydocker'
alias asp='aws-sso-profile'

# Config editing
alias zshrc='nvim $ZDOTDIR/.zshrc'
alias zprofile='nvim $ZDOTDIR/.zprofile'

# AWS/Docker
alias adl="aws ecr get-login-password | docker login --username AWS --password-stdin ${AWS_SSO_ACCOUNT_ID}.dkr.ecr.${AWS_SSO_DEFAULT_REGION}.amazonaws.com"

# Arch Linux
alias pacman-browse="pacman -Qq | fzf --preview 'pacman -Qil {}' --layout=reverse --bind 'enter:execute(pacman -Qil {} | less)'"

# Claude memory plugin
alias claude-mem="$HOME/.bun/bin/bun \"$HOME/.claude/plugins/marketplaces/thedotmack/plugin/scripts/worker-service.cjs\""

# === 6. Key Bindings (z4h specific) ===
z4h bindkey z4h-backward-kill-word  Ctrl+Backspace     Ctrl+H
z4h bindkey z4h-backward-kill-zword Ctrl+Alt+Backspace

z4h bindkey undo Ctrl+/ Shift+Tab  # undo the last command line change
z4h bindkey redo Alt+/             # redo the last undone command line change

z4h bindkey z4h-cd-back    Alt+Left   # cd into the previous directory
z4h bindkey z4h-cd-forward Alt+Right  # cd into the next directory
z4h bindkey z4h-cd-up      Alt+Up     # cd into the parent directory
z4h bindkey z4h-cd-down    Alt+Down   # cd into a child directory

# === 7. Functions ===
# Simple utility functions
function md() { [[ $# == 1 ]] && mkdir -p -- "$1" && cd -- "$1" }

function copyfile() {
    if ! tee "$1" >(pbcopy); then
        echo "Error: Failed to write file or copy to clipboard" >&2
        return 1
    fi
}

# Yazi TUI file manager wrapper (updates shell CWD on exit)
function y() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
	command yazi "$@" --cwd-file="$tmp"
	IFS= read -r -d '' cwd < "$tmp"
	[ "$cwd" != "$PWD" ] && [ -d "$cwd" ] && builtin cd -- "$cwd"
	rm -f -- "$tmp"
}

# AWS SSO profile management
function get_assumed_role_credentials() {
    if [ $# -lt 2 ]; then
        echo "Usage: get_assumed_role_credentials <role-arn> <session-name>"
        echo "You must already have credentials in your environment for the account you are assuming a role in."
        echo "Use aws-sso-profile, or asp if you are using my aliases, and select the role for the account via the autocompletion mechanism."
        return 1
    fi

    export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \
    $(aws sts assume-role \
    --role-arn $1 \
    --role-session-name $2 \
    --query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]" \
    --output text))
}

# BEGIN_AWS_SSO_CLI
# AWS SSO requires `bashcompinit` which needs to be enabled once and
# only once in your shell. The autoload lines are at the top of this file,
# OUTSIDE of the BEGIN/END_AWS_SSO_CLI markers.

__aws_sso_profile_complete() {
     local _args=${AWS_SSO_HELPER_ARGS:- -L error}
    _multi_parts : "($(/opt/homebrew/bin/aws-sso ${=_args} list --csv Profile))"
}

aws-sso-profile() {
    local _args=${AWS_SSO_HELPER_ARGS:- -L error}
    if [ -n "$AWS_PROFILE" ]; then
        echo "Unable to assume a role while AWS_PROFILE is set"
        return 1
    fi

    if [ -z "$1" ]; then
        echo "Usage: aws-sso-profile <profile>"
        return 1
    fi

    eval $(/opt/homebrew/bin/aws-sso ${=_args} eval -p "$1")
    if [ "$AWS_SSO_PROFILE" != "$1" ]; then
        return 1
    fi
}

aws-sso-clear() {
    local _args=${AWS_SSO_HELPER_ARGS:- -L error}
    if [ -z "$AWS_SSO_PROFILE" ]; then
        echo "AWS_SSO_PROFILE is not set"
        return 1
    fi
    eval $(/opt/homebrew/bin/aws-sso ${=_args} eval -c)
}
# END_AWS_SSO_CLI

# === 8. Tool Initializations (after PATH is set) ===
# These tools need to be initialized after PATH is configured

# zoxide (smart cd)
eval "$(zoxide init --cmd cd zsh)"

# mise (polyglot runtime manager)
eval "$(~/.local/bin/mise activate zsh)"

# atuin (shell history)
[[ -f "$HOME/.local/bin/env" ]] && . "$HOME/.local/bin/env" || true
[[ -f "$HOME/.atuin/bin/env" ]] && . "$HOME/.atuin/bin/env" || true
eval "$(atuin init zsh)"

# === 9. Completions ===
# Add Homebrew completions to fpath
fpath+=$(brew --prefix)/share/zsh/site-functions

# Set up completions for custom functions
compdef _directories md
compdef __aws_sso_profile_complete aws-sso-profile
complete -C /opt/homebrew/bin/aws-sso aws-sso

# === 10. Optional Integrations (last, least critical) ===
# OrbStack: command-line tools and integration
source ~/.orbstack/shell/init.zsh 2>/dev/null || :

# Source profile.d directory if it exists (for optional per-tool configs)
# Create with: mkdir -p ~/.config/zsh/profile.d && echo 'export FOO=bar' > ~/.config/zsh/profile.d/custom.zsh
if [[ -d "${ZDOTDIR}/profile.d" ]]; then
    for file in "${ZDOTDIR}"/profile.d/*.zsh(N); do
        source "$file"
    done
fi

# Dev container orchestrator (optional)
dev_env_file="${XDG_CONFIG_HOME:-$HOME/.config}/dev-container/dev-env.zsh"
[[ -f "$dev_env_file" ]] && source "$dev_env_file" || true

# ============================================================================
# Profiling output (uncomment if you enabled zprof at the top)
# zprof
